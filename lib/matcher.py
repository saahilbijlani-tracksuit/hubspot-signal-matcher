"""\nSignal Matcher - Core matching logic\n"""\nimport os\nfrom typing import List, Optional\nfrom dataclasses import dataclass\nfrom .hubspot_client import HubSpotClient\nfrom .supabase_client import SupabaseClient\nfrom .embeddings import EmbeddingGenerator\n\n\n@dataclass\nclass MatchResult:\n    hubspot_id: str\n    name: str\n    match_type: str\n    similarity: float\n    association_created: bool = False\n\n\nclass SignalMatcher:\n    def __init__(self, hubspot_token: Optional[str] = None, supabase_url: Optional[str] = None,\n                 supabase_key: Optional[str] = None, openai_key: Optional[str] = None, confidence_threshold: float = 0.85):\n        self.hubspot = HubSpotClient(access_token=hubspot_token)\n        self.supabase = SupabaseClient(url=supabase_url, key=supabase_key)\n        self.embeddings = EmbeddingGenerator(api_key=openai_key)\n        self.threshold = float(os.environ.get("CONFIDENCE_THRESHOLD", confidence_threshold))\n    \n    def match_signal(self, signal_id: str) -> dict:\n        print(f"Processing signal {signal_id}...")\n        signal = self.hubspot.get_signal(signal_id)\n        properties = signal["properties"]\n        signal_type = properties.get("signal_type", "company")\n        description = properties.get("signal_description", "")\n        citation = properties.get("signal_citation", "")\n        \n        existing_companies = signal["associations"].get("companies", [])\n        existing_contacts = signal["associations"].get("contacts", [])\n        \n        if existing_companies or existing_contacts:\n            print(f"Signal already has associations: {len(existing_companies)} companies, {len(existing_contacts)} contacts")\n        \n        signal_text = self.embeddings.prepare_signal_text(description, citation)\n        if not signal_text.strip():\n            return {"signal_id": signal_id, "signal_type": signal_type, "error": "No text content to match", "company_matches": [], "contact_matches": []}\n        \n        signal_embedding = self.embeddings.generate_embedding(signal_text)\n        company_matches: List[MatchResult] = []\n        contact_matches: List[MatchResult] = []\n        \n        if signal_type in ["company", "company_contact"]:\n            company_results = self.supabase.search_companies(embedding=signal_embedding, threshold=self.threshold, limit=10)\n            for result in company_results:\n                match = MatchResult(hubspot_id=result["hubspot_id"], name=result.get("name", "Unknown"), match_type="company", similarity=result["similarity"])\n                company_matches.append(match)\n                print(f"Company match: {match.name} ({match.similarity:.2%})")\n        \n        if signal_type in ["contact", "company_contact"]:\n            contact_results = self.supabase.search_contacts(embedding=signal_embedding, threshold=self.threshold, limit=10)\n            for result in contact_results:\n                full_name = " ".join(filter(None, [result.get("firstname", ""), result.get("lastname", "")])) or "Unknown"\n                match = MatchResult(hubspot_id=result["hubspot_id"], name=full_name, match_type="contact", similarity=result["similarity"])\n                contact_matches.append(match)\n                print(f"Contact match: {match.name} ({match.similarity:.2%})")\n        \n        associations_created = 0\n        for match in company_matches:\n            if match.hubspot_id not in existing_companies:\n                success = self.hubspot.create_signal_company_association(signal_id=signal_id, company_id=match.hubspot_id)\n                match.association_created = success\n                if success: associations_created += 1\n                self.supabase.log_match(signal_id=signal_id, matched_type="company", matched_hubspot_id=match.hubspot_id, confidence=match.similarity, association_created=success)\n        \n        for match in contact_matches:\n            if match.hubspot_id not in existing_contacts:\n                success = self.hubspot.create_signal_contact_association(signal_id=signal_id, contact_id=match.hubspot_id)\n                match.association_created = success\n                if success: associations_created += 1\n                self.supabase.log_match(signal_id=signal_id, matched_type="contact", matched_hubspot_id=match.hubspot_id, confidence=match.similarity, association_created=success)\n        \n        result = {\n            "signal_id": signal_id, "signal_type": signal_type, "signal_text": signal_text[:200],\n            "company_matches": [{"hubspot_id": m.hubspot_id, "name": m.name, "similarity": m.similarity, "association_created": m.association_created} for m in company_matches],\n            "contact_matches": [{"hubspot_id": m.hubspot_id, "name": m.name, "similarity": m.similarity, "association_created": m.association_created} for m in contact_matches],\n            "total_matches": len(company_matches) + len(contact_matches), "associations_created": associations_created\n        }\n        print(f"Completed: {result['total_matches']} matches, {associations_created} associations created")\n        return result\n\n\ndef match_signal_standalone(signal_id: str) -> dict:\n    matcher = SignalMatcher()\n    return matcher.match_signal(signal_id)\n