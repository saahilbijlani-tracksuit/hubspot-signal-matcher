name: Debug Secrets

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Test Secrets Format
        env:
          HUBSPOT_ACCESS_TOKEN: ${{ secrets.HUBSPOT_ACCESS_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python -c "
import os
import sys

print('=== Checking Secrets Format ===')
print()

# Check each secret
secrets_ok = True

# SUPABASE_URL
url = os.environ.get('SUPABASE_URL', '')
print(f'SUPABASE_URL length: {len(url)}')
print(f'SUPABASE_URL starts with https://: {url.startswith(\"https://\")}')
print(f'SUPABASE_URL ends with .supabase.co: {url.rstrip(\"/\").endswith(\".supabase.co\")}')
if not url.startswith('https://') or not '.supabase.co' in url:
    print('  ‚ùå SUPABASE_URL format issue!')
    secrets_ok = False
else:
    print('  ‚úÖ SUPABASE_URL looks good')
print()

# SUPABASE_KEY  
key = os.environ.get('SUPABASE_KEY', '')
print(f'SUPABASE_KEY length: {len(key)}')
print(f'SUPABASE_KEY starts with eyJ: {key.startswith(\"eyJ\")}')
if len(key) < 100 or not key.startswith('eyJ'):
    print('  ‚ùå SUPABASE_KEY format issue!')
    secrets_ok = False
else:
    print('  ‚úÖ SUPABASE_KEY looks good')
print()

# HUBSPOT_ACCESS_TOKEN
hs = os.environ.get('HUBSPOT_ACCESS_TOKEN', '')
print(f'HUBSPOT_ACCESS_TOKEN length: {len(hs)}')
print(f'HUBSPOT_ACCESS_TOKEN starts with pat-: {hs.startswith(\"pat-\")}')
if len(hs) < 20:
    print('  ‚ùå HUBSPOT_ACCESS_TOKEN too short!')
    secrets_ok = False
else:
    print('  ‚úÖ HUBSPOT_ACCESS_TOKEN looks good')
print()

# OPENAI_API_KEY
oai = os.environ.get('OPENAI_API_KEY', '')
print(f'OPENAI_API_KEY length: {len(oai)}')
print(f'OPENAI_API_KEY starts with sk-: {oai.startswith(\"sk-\")}')
if len(oai) < 20 or not oai.startswith('sk-'):
    print('  ‚ùå OPENAI_API_KEY format issue!')
    secrets_ok = False
else:
    print('  ‚úÖ OPENAI_API_KEY looks good')
print()

print('=== Testing Connections ===')
print()

# Test HubSpot
try:
    from hubspot import HubSpot
    client = HubSpot(access_token=hs)
    result = client.crm.companies.basic_api.get_page(limit=1)
    print(f'‚úÖ HubSpot connection works!')
except Exception as e:
    print(f'‚ùå HubSpot error: {e}')
    secrets_ok = False

# Test Supabase
try:
    from supabase import create_client
    sb = create_client(url.rstrip('/'), key)
    result = sb.table('companies').select('id').limit(1).execute()
    print(f'‚úÖ Supabase connection works!')
except Exception as e:
    print(f'‚ùå Supabase error: {e}')
    secrets_ok = False

# Test OpenAI
try:
    from openai import OpenAI
    client = OpenAI(api_key=oai)
    # Just init, don't make a call to save money
    print(f'‚úÖ OpenAI client initialized!')
except Exception as e:
    print(f'‚ùå OpenAI error: {e}')
    secrets_ok = False

print()
if secrets_ok:
    print('üéâ All checks passed!')
else:
    print('‚ùå Some checks failed - fix the issues above')
    sys.exit(1)
"
