# Process Signals Workflow
# Runs daily to find and match unprocessed signals

name: Process Signals

on:
  schedule:
    # Run every day at 3 AM UTC (after daily sync)
    - cron: '0 3 * * *'

  workflow_dispatch:
    inputs:
      signal_id:
        description: 'Specific Signal ID to process (optional)'
        required: false
        type: string
      limit:
        description: 'Max signals to process'
        required: false
        type: number
        default: 100
      threshold:
        description: 'Match confidence threshold (0.0-1.0)'
        required: false
        type: string
        default: '0.80'

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Process Signals
        env:
          HUBSPOT_ACCESS_TOKEN: ${{ secrets.HUBSPOT_ACCESS_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          CONFIDENCE_THRESHOLD: ${{ github.event.inputs.threshold || '0.80' }}
          PYTHONUNBUFFERED: '1'
        run: |
          echo "Using confidence threshold: $CONFIDENCE_THRESHOLD"
          if [ -n "${{ github.event.inputs.signal_id }}" ]; then
            python scripts/match_signal.py "${{ github.event.inputs.signal_id }}"
          else
            python scripts/process_all_signals.py --limit ${{ github.event.inputs.limit || 100 }}
          fi
