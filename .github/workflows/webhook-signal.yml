# Webhook-Triggered Signal Processing
# Triggered via GitHub API repository_dispatch event from Pipedream
#
# To trigger this workflow, call:
# POST https://api.github.com/repos/saahilbijlani-tracksuit/hubspot-signal-matcher/dispatches
# Headers: Authorization: Bearer <GITHUB_PAT>, Accept: application/vnd.github+json
# Body: {"event_type": "process-signal", "client_payload": {"signal_id": "<SIGNAL_ID>"}}

name: Process Signal (Webhook)

on:
  repository_dispatch:
    types: [process-signal]

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Log trigger
        run: |
          echo "Processing signal: ${{ github.event.client_payload.signal_id }}"
          echo "Triggered at: $(date -u)"
      
      - name: Validate signal ID
        run: |
          if [ -z "${{ github.event.client_payload.signal_id }}" ]; then
            echo "ERROR: No signal_id provided in webhook payload"
            exit 1
          fi
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Process Signal
        env:
          HUBSPOT_ACCESS_TOKEN: ${{ secrets.HUBSPOT_ACCESS_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CONFIDENCE_THRESHOLD: "0.85"
          PYTHONUNBUFFERED: '1'
        run: |
          python scripts/match_signal.py "${{ github.event.client_payload.signal_id }}"
      
      - name: Summary
        if: always()
        run: |
          echo "## Signal Processed" >> $GITHUB_STEP_SUMMARY
          echo "- **Signal ID**: ${{ github.event.client_payload.signal_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
