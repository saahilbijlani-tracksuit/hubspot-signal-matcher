#!/usr/bin/env python3\n"""\nInitial Setup Script - Embed all Companies and Contacts from HubSpot\n"""\nimport os\nimport sys\nimport argparse\nfrom datetime import datetime\nsys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))\nfrom tqdm import tqdm\nfrom lib.hubspot_client import HubSpotClient\nfrom lib.supabase_client import SupabaseClient\nfrom lib.embeddings import EmbeddingGenerator\n\n\ndef embed_companies(hubspot, supabase, embeddings, batch_size=50):\n    print("\\nEmbedding Companies...")\n    total = hubspot.get_company_count()\n    print(f"Total companies: {total:,}")\n    processed = 0\n    batch = []\n    with tqdm(total=total, desc="Companies") as pbar:\n        for company in hubspot.iter_all_companies():\n            text = embeddings.prepare_company_text(name=company["name"], domain=company["domain"])\n            if text.strip():\n                batch.append({"hubspot_id": company["id"], "name": company["name"], "domain": company["domain"], "text": text})\n            if len(batch) >= batch_size:\n                process_company_batch(batch, supabase, embeddings)\n                processed += len(batch)\n                pbar.update(len(batch))\n                batch = []\n        if batch:\n            process_company_batch(batch, supabase, embeddings)\n            processed += len(batch)\n            pbar.update(len(batch))\n    print(f"Processed {processed:,} companies")\n    return processed\n\n\ndef process_company_batch(batch, supabase, embeddings):\n    texts = [item["text"] for item in batch]\n    vectors = embeddings.generate_embeddings_batch(texts)\n    records = [{"hubspot_id": item["hubspot_id"], "name": item["name"], "domain": item["domain"], "embedding": emb, "embedded_text": item["text"]} for item, emb in zip(batch, vectors)]\n    supabase.upsert_companies_batch(records)\n\n\ndef embed_contacts(hubspot, supabase, embeddings, batch_size=50):\n    print("\\nEmbedding Contacts...")\n    total = hubspot.get_contact_count()\n    print(f"Total contacts: {total:,}")\n    processed = 0\n    batch = []\n    with tqdm(total=total, desc="Contacts") as pbar:\n        for contact in hubspot.iter_all_contacts():\n            text = embeddings.prepare_contact_text(firstname=contact["firstname"], lastname=contact["lastname"], company=contact["company"])\n            if text.strip():\n                batch.append({"hubspot_id": contact["id"], "firstname": contact["firstname"], "lastname": contact["lastname"], "company": contact["company"], "text": text})\n            if len(batch) >= batch_size:\n                process_contact_batch(batch, supabase, embeddings)\n                processed += len(batch)\n                pbar.update(len(batch))\n                batch = []\n        if batch:\n            process_contact_batch(batch, supabase, embeddings)\n            processed += len(batch)\n            pbar.update(len(batch))\n    print(f"Processed {processed:,} contacts")\n    return processed\n\n\ndef process_contact_batch(batch, supabase, embeddings):\n    texts = [item["text"] for item in batch]\n    vectors = embeddings.generate_embeddings_batch(texts)\n    records = [{"hubspot_id": item["hubspot_id"], "firstname": item["firstname"], "lastname": item["lastname"], "company": item["company"], "embedding": emb, "embedded_text": item["text"]} for item, emb in zip(batch, vectors)]\n    supabase.upsert_contacts_batch(records)\n\n\ndef main():\n    parser = argparse.ArgumentParser(description="Initial setup - embed all records")\n    parser.add_argument("--companies-only", action="store_true")\n    parser.add_argument("--contacts-only", action="store_true")\n    parser.add_argument("--batch-size", type=int, default=50)\n    args = parser.parse_args()\n    \n    print(f"HubSpot Signal Matcher - Initial Setup")\n    print(f"Started: {datetime.now().isoformat()}")\n    \n    required = ["HUBSPOT_ACCESS_TOKEN", "SUPABASE_URL", "SUPABASE_KEY", "OPENAI_API_KEY"]\n    missing = [v for v in required if not os.environ.get(v)]\n    if missing:\n        print(f"Missing: {', '.join(missing)}")\n        sys.exit(1)\n    \n    hubspot = HubSpotClient()\n    supabase = SupabaseClient()\n    embeddings = EmbeddingGenerator()\n    \n    companies_processed = 0\n    contacts_processed = 0\n    \n    if not args.contacts_only:\n        companies_processed = embed_companies(hubspot, supabase, embeddings, args.batch_size)\n        supabase.update_sync_metadata("companies", companies_processed)\n    \n    if not args.companies_only:\n        contacts_processed = embed_contacts(hubspot, supabase, embeddings, args.batch_size)\n        supabase.update_sync_metadata("contacts", contacts_processed)\n    \n    print(f"\\nSetup Complete!")\n    print(f"Companies: {companies_processed:,}")\n    print(f"Contacts: {contacts_processed:,}")\n    print(f"Completed: {datetime.now().isoformat()}")\n\n\nif __name__ == "__main__":\n    main()\n