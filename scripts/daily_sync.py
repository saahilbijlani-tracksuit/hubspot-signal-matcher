#!/usr/bin/env python3\n"""\nDaily Sync Script - Sync modified Companies and Contacts\n"""\nimport os\nimport sys\nimport argparse\nfrom datetime import datetime, timedelta\nsys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))\nfrom lib.hubspot_client import HubSpotClient\nfrom lib.supabase_client import SupabaseClient\nfrom lib.embeddings import EmbeddingGenerator\n\n\ndef sync_companies(hubspot, supabase, embeddings, since=None, batch_size=50):\n    print(f"\\nSyncing Companies (since: {since or 'all time'})...")\n    processed = 0\n    batch = []\n    for company in hubspot.iter_all_companies(modified_after=since):\n        text = embeddings.prepare_company_text(name=company["name"], domain=company["domain"])\n        if text.strip():\n            batch.append({"hubspot_id": company["id"], "name": company["name"], "domain": company["domain"], "text": text})\n        if len(batch) >= batch_size:\n            process_batch(batch, supabase, embeddings, "company")\n            processed += len(batch)\n            print(f"Processed {processed} companies...")\n            batch = []\n    if batch:\n        process_batch(batch, supabase, embeddings, "company")\n        processed += len(batch)\n    print(f"Synced {processed} companies")\n    return processed\n\n\ndef sync_contacts(hubspot, supabase, embeddings, since=None, batch_size=50):\n    print(f"\\nSyncing Contacts (since: {since or 'all time'})...")\n    processed = 0\n    batch = []\n    for contact in hubspot.iter_all_contacts(modified_after=since):\n        text = embeddings.prepare_contact_text(firstname=contact["firstname"], lastname=contact["lastname"], company=contact["company"])\n        if text.strip():\n            batch.append({"hubspot_id": contact["id"], "firstname": contact["firstname"], "lastname": contact["lastname"], "company": contact["company"], "text": text})\n        if len(batch) >= batch_size:\n            process_batch(batch, supabase, embeddings, "contact")\n            processed += len(batch)\n            print(f"Processed {processed} contacts...")\n            batch = []\n    if batch:\n        process_batch(batch, supabase, embeddings, "contact")\n        processed += len(batch)\n    print(f"Synced {processed} contacts")\n    return processed\n\n\ndef process_batch(batch, supabase, embeddings, entity_type):\n    texts = [item["text"] for item in batch]\n    vectors = embeddings.generate_embeddings_batch(texts)\n    if entity_type == "company":\n        records = [{"hubspot_id": item["hubspot_id"], "name": item["name"], "domain": item["domain"], "embedding": emb, "embedded_text": item["text"]} for item, emb in zip(batch, vectors)]\n        supabase.upsert_companies_batch(records)\n    else:\n        records = [{"hubspot_id": item["hubspot_id"], "firstname": item["firstname"], "lastname": item["lastname"], "company": item["company"], "embedding": emb, "embedded_text": item["text"]} for item, emb in zip(batch, vectors)]\n        supabase.upsert_contacts_batch(records)\n\n\ndef main():\n    parser = argparse.ArgumentParser(description="Daily sync")\n    parser.add_argument("--companies-only", action="store_true")\n    parser.add_argument("--contacts-only", action="store_true")\n    parser.add_argument("--full", action="store_true")\n    parser.add_argument("--hours", type=int, default=25)\n    parser.add_argument("--batch-size", type=int, default=50)\n    args = parser.parse_args()\n    \n    print(f"HubSpot Signal Matcher - Daily Sync")\n    print(f"Started: {datetime.now().isoformat()}")\n    \n    required = ["HUBSPOT_ACCESS_TOKEN", "SUPABASE_URL", "SUPABASE_KEY", "OPENAI_API_KEY"]\n    missing = [v for v in required if not os.environ.get(v)]\n    if missing:\n        print(f"Missing: {', '.join(missing)}")\n        sys.exit(1)\n    \n    hubspot = HubSpotClient()\n    supabase = SupabaseClient()\n    embeddings = EmbeddingGenerator()\n    \n    since = None if args.full else (datetime.utcnow() - timedelta(hours=args.hours)).isoformat() + "Z"\n    \n    companies_synced = 0\n    contacts_synced = 0\n    \n    if not args.contacts_only:\n        companies_synced = sync_companies(hubspot, supabase, embeddings, since=since, batch_size=args.batch_size)\n        supabase.update_sync_metadata("companies", companies_synced)\n    \n    if not args.companies_only:\n        contacts_synced = sync_contacts(hubspot, supabase, embeddings, since=since, batch_size=args.batch_size)\n        supabase.update_sync_metadata("contacts", contacts_synced)\n    \n    print(f"\\nSync Complete!")\n    print(f"Companies: {companies_synced}")\n    print(f"Contacts: {contacts_synced}")\n    print(f"Completed: {datetime.now().isoformat()}")\n\n\nif __name__ == "__main__":\n    main()\n